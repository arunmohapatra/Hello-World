import java.io.*;
import java.nio.file.*;
import java.util.*;

public class day6 {

    public static void main(String[] args) throws Exception {

        List<String> lines = Files.readAllLines(Paths.get("D:\\input.txt"));
        int rows = lines.size();
        int cols = lines.stream().mapToInt(String::length).max().orElse(0);

        // Build padded grid
        char[][] grid = new char[rows][cols];
        for (int r = 0; r < rows; r++) {
            String line = lines.get(r);
            for (int c = 0; c < cols; c++) {
                grid[r][c] = (c < line.length() ? line.charAt(c) : ' ');
            }
        }

        long grandTotal = 0;
        int col = 0;

        while (col < cols) {

            // Skip blank column separators
            if (isBlankColumn(grid, col)) {
                col++;
                continue;
            }

            // Start of problem block
            int start = col;
            while (col < cols && !isBlankColumn(grid, col)) col++;
            int end = col - 1; // inclusive

            // Find operator row for this block
            int operatorRow = findOperatorRow(grid, start, end);
            if (operatorRow == -1) {
                throw new RuntimeException("Operator not found in problem block.");
            }

            char operator = extractOperator(grid, start, end, operatorRow);

            // Each number is a column in this block → read RIGHT TO LEFT
            List<Long> numbers = new ArrayList<>();

            for (int c = end; c >= start; c--) {
                StringBuilder sb = new StringBuilder();

                // Top → operator row-1 gives digits (MSD at top)
                for (int r = 0; r < operatorRow; r++) {
                    if (Character.isDigit(grid[r][c])) {
                        sb.append(grid[r][c]);
                    }
                }

                if (sb.length() > 0) {
                    numbers.add(Long.parseLong(sb.toString()));
                }
            }

            // Compute result
            long result = (operator == '+') ? 0 : 1;
            for (long v : numbers) {
                result = (operator == '+') ? result + v : result * v;
            }

            grandTotal += result;
        }

        System.out.println("Grand Total = " + grandTotal);
    }


    private static boolean isBlankColumn(char[][] g, int c) {
        for (int r = 0; r < g.length; r++) {
            if (g[r][c] != ' ') return false;
        }
        return true;
    }

    private static int findOperatorRow(char[][] g, int start, int end) {
        for (int r = g.length - 1; r >= 0; r--) {
            for (int c = start; c <= end; c++) {
                if (g[r][c] == '+' || g[r][c] == '*') {
                    return r;
                }
            }
        }
        return -1;
    }

    private static char extractOperator(char[][] g, int start, int end, int r) {
        for (int c = start; c <= end; c++) {
            char ch = g[r][c];
            if (ch == '+' || ch == '*') return ch;
        }
        throw new RuntimeException("Operator not found in operator row " + r);
    }
}
