import java.io.*;
import java.nio.file.*;
import java.util.*;

public class day6 {

    public static void main(String[] args) throws Exception {

        List<String> lines = Files.readAllLines(Paths.get("D:\\input.txt"));
        int rows = lines.size();
        int cols = lines.stream().mapToInt(String::length).max().orElse(0);

        // Pad grid
        char[][] grid = new char[rows][cols];
        for (int r = 0; r < rows; r++) {
            String line = lines.get(r);
            for (int c = 0; c < cols; c++) {
                grid[r][c] = (c < line.length() ? line.charAt(c) : ' ');
            }
        }

        long grandTotal = 0;
        int col = 0;

        while (col < cols) {

            // Skip blank columns
            if (isBlankColumn(grid, col)) {
                col++;
                continue;
            }

            // Start of a problem block
            int start = col;

            // Move until next blank column
            while (col < cols && !isBlankColumn(grid, col)) {
                col++;
            }
            int end = col - 1;

            // Extract problem block as rows of text
            // endRow = row with operator
            int operatorRow = findOperatorRow(grid, start, end);

            if (operatorRow == -1) {
                throw new RuntimeException("Operator not found in block: " + start + "-" + end);
            }

            char operator = extractOperator(grid, start, end, operatorRow);

            List<Long> numbers = new ArrayList<>();

            // All rows ABOVE operator row contain numbers (vertically stacked)
            for (int r = 0; r < operatorRow; r++) {
                String segment = new String(grid[r], start, end - start + 1);
                // Extract all numbers in this row segment
                for (String token : segment.trim().split("\\s+")) {
                    if (token.matches("\\d+")) {
                        numbers.add(Long.parseLong(token));
                    }
                }
            }

            // Solve the problem
            long result = (operator == '+') ? 0 : 1;
            for (long num : numbers) {
                result = (operator == '+') ? result + num : result * num;
            }

            grandTotal += result;
        }

        System.out.println("Grand Total = " + grandTotal);
    }

    private static boolean isBlankColumn(char[][] g, int c) {
        for (int r = 0; r < g.length; r++) {
            if (g[r][c] != ' ') return false;
        }
        return true;
    }

    private static int findOperatorRow(char[][] g, int start, int end) {
        for (int r = g.length - 1; r >= 0; r--) {
            for (int c = start; c <= end; c++) {
                if (g[r][c] == '+' || g[r][c] == '*') {
                    return r;
                }
            }
        }
        return -1;
    }

    private static char extractOperator(char[][] g, int start, int end, int r) {
        for (int c = start; c <= end; c++) {
            char ch = g[r][c];
            if (ch == '+' || ch == '*') return ch;
        }
        throw new RuntimeException("Operator not found on row " + r);
    }
}
